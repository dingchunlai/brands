<%=include_jquery_easy_validator%>
<%=include_jquery_autocomplete%>

<%=flash[:alert] && "<div style='padding: 15px; color:red; font-size: 22px'>#{flash[:alert]}</div>"%>
<% form_for @shop, :url => (@shop.new_record? ? distributor_user_shops_path : distributor_user_shop_path(@shop)), :html => {:id=>'shop_form' } do |f| %>
    <%= f.error_messages %>
    <div class="table">
      <img src="/stylesheets/pretty_admin/img/bg-th-left.gif" width="8" height="7" alt="" class="left"/>
      <img src="/stylesheets/pretty_admin/img/bg-th-right.gif" width="7" height="7" alt="" class="right"/>
      <table class="listing form" cellpadding="0" cellspacing="0">
        <tr>
          <th class="full" colspan="2">店面信息管理</th>
        </tr>
        <tr>
          <td class="first" width="172"><strong><%= f.label :name %></strong></td>
          <td class="last">
            <%= f.text_field :name, :reg => '^\S+$', :tip => "店面名称必须填写且不能包含空格" %>
          </td>
        </tr>
        <tr>
          <td class="first" width="172"><strong><%= f.label :city_id %></strong></td>
          <td class="last"><%= f.select :city_id, ::Coupon::CITIES.map{ |value, key| [key, value] }.unshift(['请选择',0]) %></td>
        </tr>
        <tr>
          <td class="first" width="172"><span id="district_msg" style="color:red;"></span><strong><%= f.label :district_id %></strong></td>
          <td class="last">
            <%= f.select :district_id, @shop.district_options, {}, :reg => '^\w+$', :tip => '地区必须选择' %>
          </td>
        </tr>
        <tr id="business_zone_area">
          <td class="first" width="172"><strong><%= f.label :business_zone_id %></strong></td>
          <td class="last"><%= f.select :business_zone_id, @business_zone_options %></td>
        </tr>
        <tr id="markets_area">
          <td class="first" width="172"><strong><label>卖场</label></strong></td>
          <td class="last">
            <%= select_tag 'market_list', options_for_select(@market_list_options) %>
          </td>
        </tr>
        <tr>
          <td class="first" width="172"><strong><%= f.label :market_shop_id %></strong></td>
          <td class="last"><%= f.select :market_shop_id, @market_shop_options %></td>
        </tr>
        <tr>
          <td class="first" width="172"><strong><%= f.label :linkman %></strong></td>
          <td class="last"><%= f.text_field :linkman %></td>
        </tr>
        <tr>
          <td class="first" width="172"><strong><%= f.label :address %></strong></td>
          <td class="last"><%= f.text_field :address %></td>
        </tr>
        <tr>
          <td class="first" width="172"><strong><%= f.label :telphone %></strong></td>
          <td class="last"><%= f.text_field :telphone, :reg => '(^(\d{2,4}[-_－—]?)?\d{3,8}([-_－—]?\d{3,8})?([-_－—]?\d{1,7})?$)|(^0?1[35]\d{9}$)', :tip => "请填写正确的电话格式" %></td>
        </tr>
        <tr class="bg">
          <td class="first"></td>
          <td class="last"><%= f.submit @shop.new_record? ? "添 加" : "更 新" %></td>
        </tr>
      </table>
      <p>&nbsp;</p>
    </div>
<% end %>
<script type="text/javascript">
    $(function() {
        //动态调整界面元素宽度和高度
        $('tr').css('height', '35px');
        $('textarea').css('width', '400px').css('height', '100px');
        $('.hasDatepicker, #coupon_discount_amount, #coupon_return_amount, #coupon_priority').css('width', '75px');

        $('#market_list').change(function(){
            if ($(this).val() != "")
            {
                $('#distributor_shop_market_shop_id option').remove();
                $('#distributor_shop_market_shop_id').append($('<option value="">数据查询中</option>'));
                $.ajax({
                    url: '/remote/market_shops_for_market/' + $(this).val(),
                    type: 'get',
                    dataType: 'json',
                    error: function(request) {
                        alert('系统异常,请联系管理员');
                    },
                    success: function(data) {
                        $('#distributor_shop_market_shop_id option').remove();
                        if (data.length == 0)
                            $('#distributor_shop_market_shop_id').append($('<option value="">没有分店</option>'));
                        else
                            $('#distributor_shop_market_shop_id').append($('<option value="">请选择</option>'));
                        for (var i = 0; i < data.length; i++) {
                            $('<option value="' + data[i][1] + '">' + data[i][0] + '</option>').appendTo('#distributor_shop_market_shop_id');
                        }
                    }
                });
            }
        });

        //城市-地区 联动选择
        $('#distributor_shop_city_id').change(function() {
            $('#distributor_shop_district_id option').remove();
            $('#distributor_shop_district_id').append($('<option value="">数据查询中</option>'));
            $.ajax({
                url: '/remote/districts/' + $(this).val(),
                type: 'get',
                //data: {'distributor_id' : $(this).val()},
                dataType: 'json',

                error: function(request) {
                    alert('系统异常,请联系管理员');
                },

                success: function(data) {
                    $('#distributor_shop_district_id option').remove();
                    if (data.length == 0) {
                        $('#distributor_shop_district_id').append($('<option value="">没有地区</option>'));
                    }
                    else
                    {
                        $('#distributor_shop_district_id').append($('<option value="">请选择</option>'));
                    }

                    for (var i = 0; i < data.length; i++) {
                        $('<option value="' + data[i][1] + '">' + data[i][0] + '</option>').appendTo('#distributor_shop_district_id');
                    }
                    $('#distributor_shop_district_id').trigger('change');
                }
            });
        });

        //地区-商圈 及 地区-卖场分店 联动选择
        $('#distributor_shop_district_id').change(function() {
            //地区-商圈
            $('#distributor_shop_business_zone_id option').remove();
            $('#distributor_shop_business_zone_id').append($('<option value="">数据查询中</option>'));
            $.ajax({
                url: '/remote/business_zones/' + $(this).val(),
                type: 'get',
                //data: {'distributor_id' : $(this).val()},
                dataType: 'json',
                error: function(request) {
                    alert('系统异常,请联系管理员');
                },
                success: function(data) {
                    $('#distributor_shop_business_zone_id option').remove();
                    $('#distributor_shop_business_zone_id').append($('<option value="">不在商圈内</option>'));
                    for (var i = 0; i < data.length; i++) {
                        $('<option value="' + data[i][1] + '">' + data[i][0] + '</option>').appendTo('#distributor_shop_business_zone_id');
                    }
                    $('#distributor_shop_business_zone_id').trigger('change');
                }
            });
        });

        //商圈-卖场分店 联动选择 (同时判断地区)
        $('#distributor_shop_business_zone_id').change(function() {
            $('#district_msg').html('');
            $('#distributor_shop_market_shop_id option').remove();
            var district_id = $.trim($('#distributor_shop_district_id').val());
            if (district_id==''){
              $('#district_msg').html('请选择所在区域。');
              return;
            }
            $('#distributor_shop_market_shop_id').append($('<option value="">数据查询中</option>'));
            $.ajax({
                url: '/remote/market_shops/' + $(this).val() + '?district_id=' + district_id,
                type: 'get',
                //data: {'distributor_id' : $(this).val()},
                dataType: 'json',

                error: function(request) {
                    alert('系统异常,请联系管理员');
                },

                success: function(data) {
                    $('#distributor_shop_market_shop_id option').remove();
                    if (data.length == 0)
                        $('#distributor_shop_market_shop_id').append($('<option value="">没有分店</option>'));
                    else
                        $('#distributor_shop_market_shop_id').append($('<option value="">请选择</option>'));
                    var shop_ids = [];
                    for (var i = 0; i < data.length; i++) {
                        shop_ids.push(data[i][1]);
                        $('<option value="' + data[i][1] + '">' + data[i][0] + '</option>').appendTo('#distributor_shop_market_shop_id');
                    }
                    get_markets_by_shop_ids(shop_ids.join(','));
                }
            });
        });

        //取得卖场列表
        function get_markets_by_shop_ids(shop_ids){
          $('#market_list option').remove();
          $('#market_list').append($('<option value="">数据查询中</option>'));
          $.ajax({
                url: '/remote/markets_by_market_shop_ids/?market_shop_ids=' + shop_ids,
                type: 'get',
                //data: {'distributor_id' : $(this).val()},
                dataType: 'json',

                error: function(request) {
                    alert('系统异常,请联系管理员');
                },

                success: function(data) {
                    $('#market_list option').remove();
                    if (data.length == 0)
                        $('#market_list').append($('<option value="">没有卖场</option>'));
                    else
                        $('#market_list').append($('<option value="">请选择</option>'));
                    for (var i = 0; i < data.length; i++) {
                        $('<option value="' + data[i][1] + '">' + data[i][0] + '</option>').appendTo('#market_list');
                    }
                }
            });
        }
    });
</script>