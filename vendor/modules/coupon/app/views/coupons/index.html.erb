<% content_for :html_head do %>
    <script type="text/javascript" src="http://js2.51hejia.net/js/jquery/plugins/cookie/1.0.0/jquery.cookie.min.js"></script>
    <script type="text/javascript" src="http://js.51hejia.net/js/djq_tab.js"></script>
<% end %>

   <div class="width960 margin10 clearfix">
      <div class="djq_l f_l">
        <div class="djq_lcur margin10">
          <h3><%= @city.name %>地区为您提供<span class="djq_color01"><%= @coupons.total_entries %></span>张<%= Coupon.human_name %></h3>
          <%if [@tag_id, @pc_id, @brand_id, @district_id, @bz_id, @shop_id].sum > 0%>
            <div class="djq_xuanzhong"><table width="100%" border="0" cellspacing="0" cellpadding="0">
                <tr>
              <td width="60" valign="top">您已选择：</td>
              <td>
                <%select_items_for_search.each do |item|%>
                  <div><label update-url="<%=item[:url]%>"><%=item[:title]%>：<span><%=item[:value]%></span></label></div>
                <%end%>
              </td>
            </tr>
              </table>
            </div>
          <%end%>

          <%@seo_scopes = [@city.name, @keyword] unless @keyword.to_s.blank?%>
          <%@seo_scopes && set_coupon_page_meta_data(
            "#{@seo_scopes.join}，无条件现金抵用券，建材优惠券_和家网装修省钱狂频道",
            "#{@seo_scopes.join(',')},优惠券,抵用券,代金券,折扣券,装修,建材,装修省钱狂,无条件现金抵用券",
            "#{@seo_scopes.join}，使用和家网无条件现金抵用券，立即无条件抵用现金。一券在手，集优惠券、代金券、折扣券全部功能，装修省钱，尽在和家网装修省钱狂频道！"
          ) || set_coupon_page_meta_data%>

          <div class="djq_lcurtxt">
            <%if @tag_id==0 || @pc_id==0 || @brand_id==0%>
              <div class="djq_tigyhq">
                <h4>产品类别</h4>
                <table width="660" border="0" cellspacing="0" cellpadding="0">
                  <%=render :partial => 'coupons/index/search_option',
                    :locals => {:name => '行业', :id => 'tag_id', :options => @tag_options, :limit => 22} %>
                  <%=render :partial => 'coupons/index/search_option',
                    :locals => {:name => '产品', :id => 'pc_id', :options => @pc_options, :limit => 22} %>
                  <%=render :partial => 'coupons/index/search_option',
                    :locals => {:name => '品牌', :id => 'brand_id', :options => @brand_options, :limit => 22} if @tag_id!=0 || @pc_id!=0%>
                </table>
              </div>
            <%end%>
            <%if @bz_id==0 || @district_id==0 || @shop_id==0%>
              <div class="djq_tigyhq djq_tigyhq_hack">
                <h4>区域卖场</h4>
                <script type="text/javascript">
                  $(function() {
                    $('.djq_tgmaiclist').hide();
                    $('.djq_tgmaic > a').mouseover(function() {
                      $(this).next().show()
                    });
                    $('.djq_tgmaiclist').mouseover(function() {
                      $(this).show()
                    });
                    $('.djq_tgmaic > a').mouseout(function() {
                      $(this).next().hide()
                    });
                    $('.djq_tgmaiclist').mouseout(function() {
                      $(this).hide()
                    });
                  });

                </script>
                <table width="660" border="0" cellspacing="0" cellpadding="0">
                  <%=render :partial => 'coupons/index/search_option',
                    :locals => {:name => '地区', :id => 'district_id', :options => @district_options, :limit => 22} %>
                  <% if @city.pinyin != 'nanjing' %>
                  <%=render :partial => 'coupons/index/search_option',
                    :locals => {:name => '商圈', :id => 'bz_id', :options => @bz_options, :limit => 22} %>
                  <% end %>
                  <%if @market_options%>
                    <%=render :partial => 'coupons/index/market_option',
                      :locals => {:name => '卖场', :id => 'shop_id', :options => @shop_options, :market_options => @market_options, :limit => market_options_limit} %>
                  <%else%>
                    <%=render :partial => 'coupons/index/search_option',
                      :locals => {:name => '分店', :id => 'shop_id', :options => @shop_options, :limit => 22} %>
                  <%end%>
                </table>
              </div>
            <%end%>
          </div>
        </div>
        <div class="djq_find margin10">
          <div class="djq_findicon f_l">快速查找</div>
          <div class="djq_findsearch f_r">
            <form name="keyword_search" method="get">
              <input name="keyword" type="text" class="djq_findinput" title="<%= coupon_searh_explain %>" onfocus="if(this.value=='<%= coupon_searh_explain %>') this.value='';" onblur="if(this.value=='')this.value='<%= coupon_searh_explain %>';" value="<%= @keyword || coupon_searh_explain%>" /><input value="" type="submit" class="djq_findbtn" />
            </form>
          </div>
        </div>

        <a name="paixu"></a>

        <div class="djq_lcur margin10">
          <div class="djq_listtop">
            <div class="djq_sort f_l">
              排序方式：
              <%Coupon::ORDER_TYPES.each_with_index do |e, index|%><%=link_to e, query_coupon_index('order', index, 'keyword', @keyword) + '#paixu' unless index==0%><%end%>
            </div>
            <div class="djq_page f_r">
              <!--
              <span>1/100</span><a href="#" title="上一页" target="_self" class="djq_page_a01"></a><a href="#" title="下一页" target="_self" class="djq_page_a02"></a>
              -->
            </div>
          </div>
          <script type="text/javascript">
            $(function() {
              $('.djq_listbtn').hide();
              $('.djq_listcont li').mouseover(function() {
                $(this).addClass("djq_listcontbg")
                .siblings().removeClass("djq_listcontbg");
                $(".djq_listbtn").show();
              });
              $('.djq_listcont li').mouseout(function() {
                $(this).removeClass("djq_listcontbg");
                $(".djq_listbtn").hide();
              });
            });
          </script>
          <div class="djq_lcurtxt">
            <ul class="djq_listcont clearfix">
              <%@coupons.each do |coupon|%>
                <li><a href="<%=coupon_show_path(coupon)%>" target="_blank"><%= image_tag(coupon_image_url(coupon.montage_image_url), :alt => coupon.title)  %></a>
                  <h4><a href="<%=coupon_show_path(coupon)%>" target="_blank"><%=coupon.title%></a></h4>
                  <p>截止: <%=coupon.activity_end_at%> <span title="<%=coupon.distributor_short_title%>">[<%=coupon.distributor_short_title(6)%>]</span></p>
                  <address>
                    地址: <%=coupon.distributor_shop_address%>
                  </address>
                  <div class="djq_listbtn">
                    <a href="<%=new_coupon_download_path(:id => coupon.id)%>" title="下载到手机" target="_blank" class="djq_listbtn_a01"></a>
                    <a href="<%=coupon_print_path(:id => coupon.id)%>" title="打印" target="_blank" class="djq_listbtn_a02"></a>
                    <a href="javascript://" title="加入我的收藏夹" data="<%=coupon.id%>,<%=coupon.title%>" class="djq_listbtn_a03"></a>
                  </div>
                  <% unless coupon.distributor.class_name.blank? %>
                    <div class="djq_tagsicon"><p class="<%= coupon.distributor.class_name.gsub("Distributor::", "").underscore %>"></p></div>
                  <% end %>
                </li>
              <%end%>
            </ul>
          </div>
          <div class="clearfix mar_10">
            <div class="pagination">
              <%= will_paginate @coupons , :class => "digg_pagination", :previous_label => "上一页", :next_label => "下一页"%>
            </div>
          </div>
        </div>
      </div>
      <div class="djq_r f_r">
        <div class="djq_rcur margin10">
          <h3>如何获得</h3>
          <div class="djq_huod_help"><a href="<%= coupon_help_path %>" target="_blank">帮助中心</a></div>
          <div class="djq_rcurtxt">
            <div class="djq_huod_info"> <span><strong>电话索取：</strong>400-602-5151</span> <span><strong>网上下载：</strong><br/>
                登陆youhui.51hejia.com</span><% if @city.pinyin == 'shanghai' %> <span class="djq_huod_hack"><strong>现场索取：</strong></span><% end %> </div>
            <!-- 当是上海地区时显示 -->
            <% if @city.pinyin == 'shanghai' %>
            <div class="djq_huod_tab" style="height: auto;">
              <ul>
                <% @districts.each do |district| %>
                <li><%= district.name.mb_chars[0] %></li>
                <% end %>
              </ul>
            </div>
            <div class="djq_huod_cont clear">
              <% @districts.each_with_index do |district, index| %>
                <div id="djq_huod_box<%= index %>" class="djq_huod_box">
                  <% if @leaflet_points[district.id].nil? %>
                      <dl>
                        <% if @city_default_leaflet.empty? %>
                            <dd><span>地址：徐汇区宜山路439号16楼</span><span>电话：400-602-5151</span><span>联系人：胡小姐</span></dd>
                        <% else %>
                            <dd>
                            <%= @city_default_leaflet["name"].to_s.blank? ? "" : "<span>名称：#{@city_default_leaflet["name"]}</span>" -%>
                            <%= @city_default_leaflet["address"].to_s.blank? ? "" : "<span>地址：#{@city_default_leaflet["address"]}</span>" -%>
                            <%= @city_default_leaflet["telephone"].to_s.blank? ? "" : "<span>电话：#{@city_default_leaflet["telephone"]}</span>" -%>
                            <%= @city_default_leaflet["shop_name"].to_s.blank? ? "" : "<span>店名：#{@city_default_leaflet["shop_name"]}</span>" -%>
                            <%= @city_default_leaflet["linkman"].to_s.blank? ? "" : "<span>联系人：#{@city_default_leaflet["linkman"]}</span>" -%>
                            </dd>
                        <% end %>
                      </dl>
                  <% else %>
                      <dl>
                        <% @leaflet_points[district.id].each do |point| %>
                            <dd>
                              <%= point.name.to_s.blank? ? "" : "<span>名称：#{point.name}</span>" -%>
                              <%= point.address.to_s.blank? ? "" : "<span>地址：#{point.address}</span>" -%>
                              <%= point.telephone.to_s.blank? ? "" : "<span>电话：#{point.telephone}</span>" -%>
                              <%= point.shop_name.to_s.blank? ? "" : "<span>店名：#{point.shop_name}</span>" -%>
                              <%= point.linkman.to_s.blank? ? "" : "<span>联系人：#{point.linkman}</span>" -%>
                            </dd>
                        <% end %>
                      </dl>
                  <% end %>
                </div>
              <% end %>
            </div>
            <% end %>
            <div class="djq_huod_btn">
              <a href="<%=coupon_subscribes_path%>" target="_blank">我要订阅</a>
              <a href="<%= coupon_help_path %>" target="_blank">如何使用</a></div>
          </div>
        </div>

        <%= render :partial => '/share/popularity_week', :locals => {:tag_id => @tag_id } %>
        <%= render :partial => '/share/common_faq' %>
        <%= render_cell :coupon, :my_coupons, :my_coupons_ids => cookies[:mycoupons] %>
        <%= render :partial => '/share/latesd_coupons' %>
        <%= render :partial => '/share/recommended_coupons' %>

        <div class="djq_rcur">
          <h3>我要提供<%= Coupon.human_name %></h3>
          <div class="djq_rcurtxt">
            <div class="djq_tgyhq">
              <p>和家网已收录优惠信息
                <label><%= Coupon.valid_count(@city.id) %></label>
                条，欢迎商户提供更多<%= Coupon.human_name %>，给广大家装家居用户更多优惠。<br/>
                联系电话： 400-602-5151<br/>
                周一至周五 9:00-17:30</p>
                <div class="djq_tgyhq_btn"><%= link_to "网上提交", new_offer_coupon_path %></div>
              <span>仅限上海.无锡.苏州.宁波.杭州.南京商户</span> </div>
          </div>
        </div>
      </div>
    </div>
    <!--content_code_end-->
<!--[if IE]>
<script src="http://js.51hejia.net/js/iepng.js" type="text/javascript"></script>
<script type="text/javascript">
    EvPNG.fix('p');  //EvPNG.fix('包含透明PNG图片的标签'); 多个标签之间用英文逗号隔开。
</script>
<![endif]-->

    <script type="text/javascript">
      $(document).ready(function(){
        
        Array.prototype.remove = function(val) {
          var index = this.indexOf(val);
          if (index > -1) {
            this.splice(index, 1);
          }
        };

        Array.prototype.indexOf = function(val) {
          for (var i = 0; i < this.length; i++) {
            if (this[i] == val) return i;
          }
          return -1;
        };

        //填充我的抵用券列表
        function push_to_my_coupons(id, title){
          $('.djq_youhq dl').append($("<dd><span><a href='javascript://'><img class='remove_my_coupon' coupon-id='" + id + "' coupon-title='" + title + "' src='http://img3.51hejia.net/img/brandimg/djq_icon02.gif' /></a></span><a href='/coupon/" + id + "' target='_blank'>" + title + "</a></dd>"));
          $('#my_coupons_counter').text(parseInt($('#my_coupons_counter').text())+1);
        }

        //载入我的抵用券
        var my_coupons = $.cookie('mycoupons') && $.cookie('mycoupons').split(',') || [];
        for (var i=0; i < my_coupons.length; i++){
          var data = my_coupons[i].split('@');
          push_to_my_coupons(data[0], data[1]);
        }

        //添加我的抵用券
        $('.djq_listbtn_a03').click(function(){
          var my_coupons = $.cookie('mycoupons') && $.cookie('mycoupons').split(',') || [];
          var datas = $(this).attr('data').split(',');
          var id = datas[0];
          var title = datas[1];
          if (my_coupons.indexOf(id + '@' + title) > -1){
            alert('操作错误：无法重复添加相同的抵用券。')
          }else{
            my_coupons.push(id + '@' + title);
            $.cookie('mycoupons', my_coupons.join(','), { expires: 30 });
            push_to_my_coupons(id, title);
          }
        });

        //删除我的抵用券
        $('.remove_my_coupon').live('click', function(){
          var my_coupons = $.cookie('mycoupons') && $.cookie('mycoupons').split(',') || [];
          my_coupons.remove($(this).attr('coupon-id') + '@' + $(this).attr('coupon-title'));
          $.cookie('mycoupons', my_coupons.join(','), { expires: 30 });
          $(this).parents('dd').remove();
          $('#my_coupons_counter').text(parseInt($('#my_coupons_counter').text())-1);
        });

        //清空抵用券
        $('a.my_coupons_remove_all').live('click', function(){
          $('.remove_my_coupon').trigger('click');
        });

        $('label[update-url]').click(function(){
          window.open($(this).attr('update-url'), '_top');
        });

        //抵用券关键词搜索
        $('form[name=keyword_search]').submit(function(){
          var tf_keyword = $(this).find('input[name=keyword]');
          var kw = $.trim(tf_keyword.val());
          tf_keyword.val(kw);
          if (kw=='<%= coupon_searh_explain %>'||kw==''){
            alert('请输入搜索关键词！');
          }else{
            window.open('/kw-' + kw + '-0.html', '_top');
          }
          return false;
        });

      });

    </script>
