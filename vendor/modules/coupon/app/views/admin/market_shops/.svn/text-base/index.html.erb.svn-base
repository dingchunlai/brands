<%
    
    if @business_zone
        city_selected = @business_zone.city_id
        district_options = District.by_city(@business_zone.city_id).collect { |item| [item.name, item.id] }.unshift(['请选择',''])
        district_selected = @business_zone.district_id
        business_zone_options = BusinessZone.by_district(@business_zone.district_id).collect { |item| [item.name, item.id] }.unshift(['请选择',''])
        business_zone_selected = @business_zone.id
    else
        city_selected = ""
        district_options = [['请选择','']]
        district_selected = ''
        business_zone_options = [['请选择','']]
        business_zone_selected = ''
    end
   #
%>
<%= top_bar :title => '卖场门店管理页',
            :button => ['创建门店', new_admin_market_shop_path(:market_id => params[:market_id])],
            :breadcrumbs => [
                    ['Homepage', coupon_admin_index_path],
                    ['MarketShops', admin_market_shops_path]
            ]
%>
<div class="select-bar">
  <%= select_tag "city_id", options_for_select(City.find(:all).collect { |item| [item.name, item.id] }.unshift(['请选择','']), city_selected) %>
  <%= select_tag "district_id", options_for_select(district_options, district_selected) %>
  <%= select_tag "business_zone_id",options_for_select(business_zone_options, business_zone_selected) %>
</div>
<div class="table">
  <img src="/stylesheets/pretty_admin/img/bg-th-left.gif" width="8" height="7" alt="" class="left"/>
  <img src="/stylesheets/pretty_admin/img/bg-th-right.gif" width="7" height="7" alt="" class="right"/>
  <table class="listing" cellpadding="0" cellspacing="0">
    <tr>
      <th class="first">编号</th>
      <th><%= MarketShop.human_attribute_name("name") %></th>
      <th><%= MarketShop.human_attribute_name("city_id") %></th>
      <th><%= MarketShop.human_attribute_name("district_id") %></th>
      <th><%= MarketShop.human_attribute_name("business_zone_id") %></th>
      <th><%= MarketShop.human_attribute_name("market_id") %></th>
      <th><%= MarketShop.human_attribute_name("address") %></th>
      <th><%= MarketShop.human_attribute_name("telphone") %></th>
      <th colspan=3 class="last">操作</th>
    </tr>
    <% @market_shops.each_with_index do |market_shop, index| %>
        <tr<%= (index % 2 == 0) ? '' : ' class="bg"' -%>>
          <td height="25"><%= market_shop.id %></td>
          <td><%= market_shop.name %></td>
          <td><%= link_to (market_shop.city.nil? ? '---' : market_shop.city.name ), admin_city_path(market_shop.city_id) %></td>
          <td><%= link_to (market_shop.district.nil? ? '---' : market_shop.district.name), admin_district_path(market_shop.district_id) %></td>
          <td>
            <% if market_shop.business_zone_id.to_i == 0 %>
                -
            <% else %>
                <%= link_to (market_shop.business_zone.nil? ? '---' : market_shop.business_zone.name), admin_business_zone_path(market_shop.business_zone_id) %>
            <% end %>

          </td>
          <td><%= link_to market_shop.market.name, admin_market_path(market_shop.market_id) %></td>
          <td><%= market_shop.address %></td>
          <td><%= market_shop.telphone %></td>
          <td>
            <% if can? :read, market_shop %>
                <%= link_to '查看', admin_market_shop_path(market_shop) %>
            <% else %>
                &nbsp;
            <% end %>
          </td>
          <td>
            <% if can? :update, market_shop %>
                <%= link_to '修改', edit_admin_market_shop_path(market_shop) %>
            <% else %>
                &nbsp;
            <% end %>
          </td>
          <!--<td><%#= link_to '删除', admin_market_shop_path(market_shop), :confirm => 'Are you sure?', :method => :delete %></td>-->
        </tr>
    <% end %>
  </table>
  <% unless @market_shops.empty? -%>
      <%= will_paginate @market_shops, :class => "digg_pagination" -%>
  <% end -%>
</div>
<script type="text/javascript">
    $(function() {

        var city_id = "city_id";
        var district_id = "district_id";
        var business_zone_id = "business_zone_id";

        $("#" + city_id).change(function(){
            if ($(this).val() == "") { return null; }
            $('#' + district_id + ' option').remove();
            $('#' + district_id).append($('<option value="">loading...</option>'));
            $.ajax({
                url: '/remote/districts/',
                type: 'get',
                data: {'id' : $(this).val()},
                dataType: 'json',

                error: function(request) {
                    alert("请联系管理员");
                },

                success: function(data) {
                    $('#' + district_id + ' option').remove();
                    //if (data.length == 0) $('#' + district_id).append($('<option value="">没有地区</option>'));
                    $('#' + district_id).append($('<option value="">请选择</option>'));
                    for (var i = 0; i < data.length; i++) {
                        $('<option value="' + data[i][1] + '">' + data[i][0] + '</option>').appendTo('#' + district_id);
                    }
                }
            });
        });

        $("#" + district_id).change(function(){
            if ($(this).val() == "") { return null; }
            $('#' + business_zone_id + ' option').remove();
            $('#' + business_zone_id).append($('<option value="">loading...</option>'));
            $.ajax({
                url: '/remote/business_zones/',
                type: 'get',
                data: {'id' : $(this).val()},
                dataType: 'json',

                error: function(request) {
                    alert("请联系管理员");
                },

                success: function(data) {
                    $('#' + business_zone_id + ' option').remove();
                    $('#' + business_zone_id).append($('<option value="">请选择</option>'));
                    for (var i = 0; i < data.length; i++) {
                        $('<option value="' + data[i][1] + '">' + data[i][0] + '</option>').appendTo('#' + business_zone_id);
                    }
                }
            });
        });

        $("#" + business_zone_id).change(function(){
            if ($(this).val() == "") { return; }
            // location.href = "</%= admin_market_shops_path / ...  %/>"
            location.href = "/admin/market_shops?business_zone_id=" + $(this).val();
        });

    });
</script>