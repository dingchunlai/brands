<%= include_jquery_easy_validator %>

<%= top_bar :title => '卖场管理页',
            :button => ['卖场列表', admin_markets_path],
            :breadcrumbs => [
                    ['Homepage', coupon_admin_index_path],
                    ['Markets', admin_markets_path]
            ]
%>
<%=flash[:notice] && "<div style='padding: 15px; color:blue; font-size: 22px'>#{flash[:notice]}</div>"%>
<% form_for @market, :url => admin_markets_path do |f| %>
    <%= f.error_messages %>
    <div class="table">
      <img src="/stylesheets/pretty_admin/img/bg-th-left.gif" width="8" height="7" alt="" class="left"/>
      <img src="/stylesheets/pretty_admin/img/bg-th-right.gif" width="7" height="7" alt="" class="right"/>
      <table class="listing form" cellpadding="0" cellspacing="0">
        <tr>
          <th class="full" colspan="2">创建卖场</th>
        </tr>
        <tr class="bg">
          <td class="first" width="172"><strong><%= f.label :name %></strong></td>
          <td class="last"><%= f.text_field :name, :class => "text", :reg => '^\S+$', :tip => "必须*" %></td>
        </tr>
        <tr id="form_add_shop">
          <td colspan="2">
            <% f.fields_for :market_shops do |builder| %>
            <table width="100%">
                  <tr class="bg">
                    <td class="first" width="230">
                      <%= builder.label :name %>
                    </td>
                    <td class="last">
                      <%= builder.text_field :name, :reg => '^\S+$', :tip => "必须*" %>
                    </td>
                  </tr>
                  <tr class="bg">
                    <td class="first">
                      <%= builder.label :city_id %>
                    </td>
                    <td class="last">
                      <%= builder.select :city_id, City.find(:all).collect { |item| [ item.name, item.id ] }.unshift(["请选择", '']), :selected => '',:reg => '^\S+$',  :tip => "必须*" %>
                    </td>
                  </tr>
                  <tr class="bg">
                    <td class="first">
                      <%= builder.label :district_id %>
                    </td>
                    <td class="last">
                      <%= builder.select :district_id, [], :include_blank => '请选择',:reg => '^\S+$',  :tip => "必须*" %>
                    </td>
                  </tr>
                  <tr class="bg">
                    <td class="first">
                      <%= builder.label :business_zone_id %>
                    </td>
                    <td class="last">
                      <%= builder.select :business_zone_id, [], :include_blank => '请选择' %>
                    </td>
                  </tr>
                  <tr class="bg">
                    <td class="first">
                      <%= builder.label :address %>
                    </td>
                    <td class="last">
                      <%= builder.text_field :address, :reg => '^\S+$', :tip => "必须*"%>
                    </td>
                  </tr>
                  <tr class="bg">
                    <td class="first">
                      <%= builder.label :telphone %>
                    </td>
                    <td class="last">
                      <%= builder.text_field :telphone %><%= builder.hidden_field :when_market_create %>
                    </td>
                  </tr>
            </table>
            <% end %>
          </td>
        </tr>
        <tr>
          <td colspan="2"><%= f.submit '提交' %></td>
        </tr>
      </table>
    </div>
<% end %>
<script type="text/javascript">
    $(function() {

        var city_id = $("select[id^='market_market_shops_attributes'][name*='city_id']")[0].id;
        var district_id = $("select[id^='market_market_shops_attributes'][name*='district_id']")[0].id;
        var business_zone_id = $("select[id^='market_market_shops_attributes'][name*='business_zone_id']")[0].id;

        $("#" + city_id).change(function(){
            if ($(this).val() == "") { return null; }
            $('#' + district_id + ' option').remove();
            $('#' + district_id).append($('<option value="">loading...</option>'));
            $.ajax({
                url: '/remote/districts/',
                type: 'get',
                data: {'id' : $(this).val()},
                dataType: 'json',

                error: function(request) {
                    alert(request.responseText);
                },

                success: function(data) {
                    $('#' + district_id + ' option').remove();
                    //if (data.length == 0) $('#' + district_id).append($('<option value="">没有地区</option>'));
                    $('#' + district_id).append($('<option value="">请选择</option>'));
                    for (var i = 0; i < data.length; i++) {
                        $('<option value="' + data[i][1] + '">' + data[i][0] + '</option>').appendTo('#' + district_id);
                    }
                }
            });
        });

        $("#" + district_id).change(function(){
            if ($(this).val() == "") { return null; }
            $('#' + business_zone_id + ' option').remove();
            $('#' + business_zone_id).append($('<option value="">loading...</option>'));
            $.ajax({
                url: '/remote/business_zones/',
                type: 'get',
                data: {'id' : $(this).val()},
                dataType: 'json',

                error: function(request) {
                    alert(request.responseText);
                },

                success: function(data) {
                    $('#' + business_zone_id + ' option').remove();
                    $('#' + business_zone_id).append($('<option value="">请选择</option>'));
                    for (var i = 0; i < data.length; i++) {
                        $('<option value="' + data[i][1] + '">' + data[i][0] + '</option>').appendTo('#' + business_zone_id);
                    }
                }
            });
        });
        
        
    });
</script>