<%= top_bar :title => '经销商详情',
  :button => ['创建经销商', new_admin_distributor_path],
  :breadcrumbs => [
    ['抵用券后台', coupon_admin_index_path],
    ["#{Distributor.id_to_title(@distributor)}", admin_distributor_shops_path(@distributor)],
  ]
%>

<%
  contract_total_count = 0
  valid_contract_count = 0
  expired_contract_count = 0
  unless @structs.empty?
    @structs.each do |struct|
      if struct.status == "valid"
        valid_contract_count = struct.contracts.size
      elsif struct.status == "expired"
        expired_contract_count = struct.contracts.size
      end
    end
  end
  contract_total_count = valid_contract_count + expired_contract_count
%>

<div class="table">
  <img src="/stylesheets/pretty_admin/img/bg-th-left.gif" width="8" height="7" alt="" class="left" />
  <img src="/stylesheets/pretty_admin/img/bg-th-right.gif" width="7" height="7" alt="" class="right" />
  <table class="listing" cellpadding="0" cellspacing="0">
    <tr>
      <th class="first" width="33%">经销商编号:<%= @distributor.code %></th>
          <th class="last" colspan="2">经销商简称:<%= @distributor.short_title %></th>
      </tr>
    <tr>
      <th class="first" width="33%">
        <% if can?(:read, Distributor::Contract) || can?(:read_owned_contracts, Distributor::Contract) %>
          <%= link_to "合同", admin_distributor_contracts_path(:distributor_id => params[:id])%>
        <% else %>
          合同
        <% end %>
      </th>
      <th width="33%">
        <% if can?(:read, Coupon) || can?(:read_owned_coupons, :coupons) %>
          <%= link_to "抵用券", admin_coupons_path(:distributor_id => params[:id]) %>
        <% else %>
          抵用卷
        <% end %>
      </th>
      <th class="last">被投诉次数</th>
    </tr>
    <tr>
      <td width="33%">
        <table width="100%">
          <tr>
            <td>共有 <%= contract_total_count %> 张</td>
          </tr>
          <tr>
            <td>签约 <%= valid_contract_count %> 张</td>
          </tr>
          <tr>
            <td>过期 <%= expired_contract_count %> 张</td>
          </tr>
        </table>
      </td>
      <td width="33%" valign="top">
        <table width="100%">
          <tr>
            <td>共有 <%= @coupon_total_count %> 家</td>
          </tr>
          <tr>
            <td>有效 <%= @coupon_valid_count %> 家</td>
          </tr>
          <tr>
            <td>&nbsp;</td>
          </tr>
          <tr>
            <td>&nbsp;</td>
          </tr>
        </table>
      </td>
      <td valign="top">
        <table width="100%">
          <tr>
            <td><%= @distributor.complaints_count%> 次</td>
          </tr>
          <tr>
            <td>&nbsp;</td>
          </tr>
          <tr>
            <td>&nbsp;</td>
          </tr>
          <tr>
            <td>&nbsp;</td>
          </tr>
        </table>
      </td>
    </tr>
  </table>

  <div style="padding:7px; color:#757575">
    <% if can? (:read, Coupon) || can? (:read_owned_coupons, :coupons) %>
      <%=link_to '抵用券列表', admin_coupons_path(:distributor_id => @distributor.id), :target => '_blank'%>
    <% else %>
      抵用卷
    <% end %>
  </div>
  
  <table class="listing" cellpadding="0" cellspacing="0">
    <tr>
      <th>code</th>
      <th class="first" width="177">抵用券标题</th>
      <th>经销商</th>
      <th>店面</th>
      <th>起始日期</th>
      <th>线下发放</th>
      <th>管理</th>
    </tr>
    <%@coupons.each do |coupon|%>
      <tr>
        <td> <%=coupon.code%> </td>
        <td class="first style4"><%= coupon.title %></td>
        <td> <%=coupon.distributor_title%> </td>
        <td> <%=coupon.shop_name%> </td>
        <td> <%=coupon.activity_began_at%> </td>
        <td> <%=coupon.offline_event ? '有' : '<span style="color: #CBC">无</span>'%> </td>
        <td class="last">
          <% if can?(:update, coupon) || can?(:edit_owned_coupon, :coupons) %>
            <%= link_to '编辑', edit_admin_coupon_path(coupon), :target => '_blank'%> 
          <% end %>|
        </td>
      </tr>
    <%end%>
  </table>

  <div style="padding:7px; color:#757575">
    <% if can?(:read, Distributor::Shop) || can?(:read_owned_shops, Distributor::Shop) %> 
      <%=link_to '店面列表', admin_distributor_shops_path(@distributor) %>
    <% else %>
      店面
    <% end %>
  </div>

  <table class="listing" cellpadding="0" cellspacing="0">
    <tr>
      <th class="first" width="177">店面名称</th>
      <th>城市</th>
      <th>地区</th>
      <th>商圈</th>
      <th>分店</th>
      <th class="last" colspan="2">管理</th>
    </tr>
    <%@shops.each do |shop|%>
      <tr>
        <td class="first style4">
          <%= shop.name %> 
        </td>
        <td> <%=shop.city.name%> </td>
        <td> <%=shop.district%> </td>
        <td> <%=shop.business_zone%> </td>
        <td> <%=shop.market_shop%> </td>
        <td> 
          <% if can?(:read, Coupon) || can?(:read_owned_coupons, :coupons) %>
            <%= link_to '抵用券', admin_coupons_path(:shop_id => shop.id) %>
          <% end %>
        </td>
        <td>
          <% if can?(:update, shop) || can?(:edit_owned_shop, shop) %>
            <%= link_to '编辑', edit_admin_distributor_shop_path(shop.distributor_id, shop) %>
          <% end %>
        </td>
      </tr>
    <%end%>
  </table>

  <div style="padding:7px; color:#757575">
    <% if can? (:read, Distributor::Contract) || (can? :read_owned_contracts, Distributor::Contract) %>
       <%= link_to "合同列表", admin_distributor_contracts_path(@distributor), :target => '_blank'%>
    <% else %>
      合同
    <% end %>
  </div>

  <table class="listing" cellpadding="0" cellspacing="0">
    <tr>
      <th class="first" width="177">标题</th>
      <th>开始时间</th>
      <th>结果时间</th>
      <th>合同编号</th>
      <th>描述</th>
      <th colspan="2"></th>
    </tr>
    <% @contracts && @contracts.each do |contract| %>
      <tr>
        <td class="first style4"><%=h contract.title %></td>
        <td><%= contract.start_date.strftime("%Y-%m-%d") %></td>
        <td><%= contract.end_date.strftime("%Y-%m-%d") %></td>
        <td><%=h contract.code %></td>
        <td><%=h contract.description %></td>
        <td>
          <% if (can? :read, contract) || (can? :read_owned_contracts, Distributor::Contract) %>
            <%= link_to '查看', admin_distributor_contract_path(contract.distributor_id, contract) %>
          <% end %>
        </td>
        <td>
          <% if (can? :update, contract) || (can? :edit_owned_contract, contract)  %>
            <%= link_to '编辑', edit_admin_distributor_contract_path(contract.distributor_id, contract) %>
          <% end %>
        </td>
      </tr>
    <% end %>
  </table>

</div>
