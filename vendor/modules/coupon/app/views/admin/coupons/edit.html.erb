<%=include_jquery_easy_validator%>
<%=include_jquery_autocomplete%>

<%= top_bar :title => '抵用券管理',
  :button => ['返回列表', admin_coupons_path],
  :breadcrumbs => [
  ['抵用券后台', coupon_admin_index_path],
  ['抵用券管理', admin_coupons_path]
]
%>

<!--
<div class="select-bar">
  <label>
    <input type="text" name="textfield" />
  </label>
  <label>
    <input type="submit" name="Submit" value="Search" />
  </label>
</div>
-->

<%=flash[:notice] && "<div style='padding: 15px; color:blue; font-size: 22px'>#{flash[:notice]}</div>"%>
<%=flash[:alert] && "<div style='padding: 15px; color:red; font-size: 22px'>#{flash[:alert]}</div>"%>
<%#= show_flash_message %>

<%form_for [:admin, @coupon], :html => {:id=>'coupon_form', 'data-uploadurl' => cloud_fs_upload_path('image'), 'data-assetsurl' => cloud_fs_domain('image')}  do |f|%>
  <%= f.error_messages %>
  <div class="table">
    <img src="/stylesheets/pretty_admin/img/bg-th-left.gif" width="8" height="7" alt="" class="left" />
    <img src="/stylesheets/pretty_admin/img/bg-th-right.gif" width="7" height="7" alt="" class="right" />
    <table class="listing form" cellpadding="0" cellspacing="0">
      <tr>
        <th class="full" colspan="2">抵用券信息管理</th>
      </tr>
      <tr>
        <td class="first" width="172"><strong><%= f.label :title %></strong></td>
        <td class="last"><%= f.text_field :title %></td>
      </tr>

      <tr>
        <td class="first" width="172"><strong><%= f.label :distributor_id %></strong></td>
        <td class="last">
          <% if @coupon.new_record? %>
            <%= f.select :distributor_id, ['请选择', ''] %>
          <% else %>
            <%= f.select :distributor_id, Distributor.all(:select => 'id, title', :conditions => ["id = ?", @coupon.distributor_id]).map{|r| [r.title, r.id]} %>
          <% end %>
          <!--<input id="query_distributor_button" type="button" value="<-" />　-->
          <%= text_field_tag :query_distributor, '', 'query-url' => '/remote/distributors_by_title' %>(*输入经销商名称, 选择后自动更新)
        </td>
      </tr>
      <tr>
        <td class="first" width="172"><strong><%= f.label :contract_id %></strong></td>
        <td class="last"><%= f.select :contract_id, @coupon.contract_options, {}, :reg => '^\S+$', :tip => "经销商合同必须选择" %><span id="contact_code"></span></td>
      </tr>
      <tr>
        <td class="first" width="172"><strong><%= f.label :shop_id %></strong></td>
        <td class="last"><%= f.select :shop_id, Distributor::Shop.by_distributor(@coupon.distributor_id).map{|r| [r.name, r.id]}, {}, :reg => '^\w+$', :tip => "必须选择"%></td>
      </tr>
      <tr>
        <td class="first" width="172"><strong><%= f.label :tag_id %></strong></td>
        <td class="last"><%= f.select :tag_id, Tag.select_options.unshift(['请选择','']), {}, :reg => '^\w+$', :tip => "必须选择" %></td>
      </tr>
      <tr>
        <td class="first" width="172"><strong><%= f.label :brand_id %></strong></td>
        <td class="last">
          <%= f.select :brand_id, @coupon.tag_id.to_i==0 ? [['请选择行业','']] : Brand.of_tag(@coupon.tag_id, true).map{ |b| [b.name_zh, b.id] }, {}, :reg => '^\w+$', :tip => "必须选择" %>
          <input type="text" id="txt_brand" name="txt_brand" /><input type="button" id="btn_fetch_brand" value="定位品牌"/>
     </td>
      </tr>
      <tr>
        <td class="first" width="172"><strong><%= f.label :production_category_id %></strong></td>
        <td class="last" id="production_category_ids_td">
          <%=production_category_check_box_tags(@coupon)%>
        </td>
      </tr>
      <tr>
        <td class="first" width="172"><strong><%= f.label :discount_amount %></strong></td>
        <td class="last"><%= f.text_field :discount_amount, :reg => '^[1-9]\d*$', :tip => "满多少金额必须填写数字" %>元启用</td>
      </tr>
      <tr>
        <td class="first" width="172"><strong><%= f.label :return_amount %></strong></td>
        <td class="last"><%= f.text_field :return_amount, :reg => '^[1-9]\d*$', :tip => "抵用多少金额必须填写数字" %>元</td>
      </tr>
      <% if @coupon.new_record? %>
      <tr>
        <td class="first" width="172"><strong><%= f.label :total_issue_number %></strong></td>
        <td class="last"><%= f.text_field :total_issue_number, :reg => '^[1-9]\d*$', :tip => "必须填写数字" %> * 请填写数字

        <%= f.hidden_field :virtual_existing_number, :value => 1 %>
        </td>
      </tr>
      <% end %>
      <tr>
        <td class="first" width="172"><strong><%= f.label :brand_industry_name %></strong></td>
        <td class="last"><%= f.text_field :brand_industry_name %>* 如果希望自动合成，请保证此输入框为空值 （请将字数控制在7个内）</td>
      </tr>
      <%unless @coupon.new_record?%>
        <tr>
          <td class="first" width="172"><strong><%= f.label :sms_msg %></strong></td>
          <td class="last">
              <%= f.text_area :sms_msg%>
          </td>
        </tr>
      <%end%>
      <tr>
        <td class="first" width="172"><strong><%= f.label :activity_began_at %></strong></td>
        <td class="last"><%= f.text_field :activity_began_at%></td>
      </tr>
      <tr>
        <td class="first" width="172"><strong><%= f.label :activity_end_at %></strong></td>
        <td class="last"><%= f.text_field :activity_end_at%></td>
      </tr>
      <%if @coupon.new_record?%>
        <tr>
          <td class="first" width="172"><strong><%= f.label :priority %></strong></td>
          <td class="last"><%= check_box_tag :is_priority %> 优先排序</td>
        </tr>
      <%end%>
     <tr>
        <td class="first" width="172"><strong><%= f.label :print_image_url %></strong></td>
        <td class="last">
          <img id="print_image_thumb" width="110" height="110" alt="打印图片预览" />
          <span id="print_image_upload_button"></span>(尺寸: 290px * 213px) 300 dpi
          <%= f.text_field :print_image_url, :style => "display:none;" %>
        </td>
      </tr>
      <tr>
        <td class="first" width="172"><strong><%= f.label :usage %></strong></td>
        <td class="last"><%= f.text_area :usage, :class => 'mceEditor' %></td>
      </tr> 
      <tr>
        <td class="first" width="172"><strong><%= f.label :seo_keywords %></strong></td>
        <td class="last"><%= f.text_field :seo_keywords %>请使用 半角逗号(,)分隔</td>
      </tr>
      <tr>
        <td class="first" width="172"><strong><%= f.label :seo_description %></strong></td>
        <td class="last"><%= f.text_area :seo_description %></td>
      </tr>
      <% if can?(:edit_commission, :coupons) and !@coupon.new_record? %>
      <tr>
        <td class="first" width="172"><strong><%= f.label :commission %></strong></td>
        <td class="last"><%= check_box_tag "update_current_month_commission"%>勾选后自动更新为本月佣金额度(降低人工录入错误率)</td>
      </tr>
      <% end %>

      <tr class="bg">
        <td class="first"></td>
        <td class="last"><%= f.submit @coupon.new_record? ? "添 加" : "确认" %></td>
      </tr>
    </table>
    <p>&nbsp;</p>
  </div>
<% end %>

<%content_for :head do%>
  <%=javascript_include_tag '/javascripts/tiny_mce/jquery.tinymce.js'%>
<%end%>

<script type="text/javascript">
  $(function() {
    $('.mceEditor').tinymce({
      script_url: <%= javascript_path('tiny_mce/tiny_mce').to_json %>,
      editor_selector: 'mceEditor',
      convert_urls : false,
      language : 'zh',
      mode : 'textareas',
      plugins : "table,fullscreen",
      relative_urls : false,
      theme : 'advanced',
      theme_advanced_buttons1 : 'bold,italic,underline,strikethrough,|,justifyleft,justifycenter,justifyright,justifyfull,|,formatselect,fontselect,fontsizeselect,|,outdent,indent,blockquote,|,undo,redo',
      theme_advanced_buttons2 : 'tablecontrols,|,hr,removeformat,visualaid,code |,hr,removeformat,visualaid,|,link,unlink,anchor,image,upload,cleanup,|,forecolor,backcolor,code',
      theme_advanced_buttons3 : '',
      theme_advanced_resize_horizontal : false,
      theme_advanced_resizing : true,
      theme_advanced_statusbar_location : 'bottom',
      theme_advanced_toolbar_align : 'left',
      theme_advanced_toolbar_location : 'top',
      visual : false,
      width : '440px'
    });
  });
</script>

<script src="http://js.51hejia.com/js/jquery.uploadify.v2.1.0.min.js" type="text/javascript"></script>
<script src="http://ajax.googleapis.com/ajax/libs/swfobject/2/swfobject.js" type="text/javascript"></script>
<script src="http://js.51hejia.com/js/brands/uploadify/coupon_image.js?<%=Time.now.to_i%>" type="text/javascript"></script>

<script type="text/javascript">
  $(function(){
    set_image($('#print_image_thumb'), $('#coupon_print_image_url'));
    //加载日期元素插件
    $("#coupon_activity_began_at").datepicker({dateFormat: 'yy-m-d'});
    $("#coupon_activity_end_at").datepicker({dateFormat: 'yy-m-d'});

    //动态调整界面元素宽度和高度
    $('tr').css('height', '35px');
//    $('input[type!=button][type!=radio][type!=submit][type!=checkbox]').css('width', '400px');
    $('textarea').css('width','400px').css('height','100px');
    $('.hasDatepicker, #coupon_discount_amount, #coupon_return_amount, #coupon_priority').css('width', '75px');
    $('#query_distributor').css('width', '100px');

//    //检索经销商（自动补全）
//    $('#query_distributor').autocomplete($('#query_distributor').attr('query-url'), {
//      max: 10,
//      minChars: 2,
//      multiple : true,
//      width: 120
//    });
      $("#query_distributor").autocomplete($('#query_distributor').attr('query-url'), {
          multiple: false,
          minChars: 2,
          width:200,
          max:10,
          multipleSeparator: ' ',
          dataType: 'json',
          //加入对返回的json对象进行解析函数，函数返回一个数组
          parse: function(data) {
              var rows = [];
              for (var i = 0; i < data.length; i++) {
                  rows[rows.length] = {
                      data:data[i].id + "-" + data[i].title,
                      value:data[i].id,
                      result:data[i].title
                  };
              }
              return rows;
          },
          formatItem: function(row, i, n) {
              return row;
          }
      });

      $("#query_distributor").result(function(event, info, formatted) {
        if (info == null) { return; }
        var data = info.split("-");
        $('#query_distributor').val('');
        $("#coupon_distributor_id option").remove();
        $('<option value="' + data[0] + '">' + data[1] + '</option>').appendTo('#coupon_distributor_id');
        $("#coupon_distributor_id").trigger('change');
      });


      $('#query_distributor_button').click(function(){
//          alert($('#query_distributor').attr("value"));
      //$("#coupon_distributor_id option:contains('" + $('#query_distributor').val() + "')").attr('selected', true);
      //$("#coupon_distributor_id option").remove();
      
      //$("#coupon_distributor_id").trigger('change');
    });

      $("#btn_fetch_brand").click(function() {
          if ($("#txt_brand").val() == "") {
              alert('请填写品牌!');
              $("#txt_brand").focus();
          } else {
              var got = false;
              $("#coupon_brand_id").css("background-color", "green");
              $("#coupon_brand_id").children().each(function(i) {
                  if ($(this).text() == $("#txt_brand").val()) {
                      got = true;
                      $("#txt_brand").attr("value", '');
                      $("#coupon_brand_id").attr("selectedIndex", $(this).attr("index"));
                      $("#coupon_brand_id").trigger('change');
                  }
              });
              $("#coupon_brand_id").css("background-color", "");
              if (!got) {
                  alert('请填写正确的品牌名称');
                  $("#txt_brand").focus();
              }
          }
      });

    //表单提交验证
    $('#coupon_form').submit(function(){
      if ($('input[name=production_category_ids[]]:checked').length == 0){
        alert('无法提交：品类必须选择！');
        return false;
      }
    });

    //短消息字数动态提示
    $('#coupon_sms_msg').keyup(function(){
      var msg = $.trim($(this).val());
      $(this).val(msg);
      $('#msg_count').text(msg.length);
      $('#msg_recount').text(70 - msg.length);
      if (msg.length > 70)
        $('#msg_count_area').css('color','red');
        else
        $('#msg_count_area').css('color','blue');
    });

    //经销商-合同联动选择
    $('#coupon_distributor_id').change(function(){
      $('#coupon_contract_id option').remove();
      $('#coupon_contract_id').append($('<option value="">数据查询中</option>'));
      $.ajax({
        url: '/remote/contracts/' + $(this).val() + "?timestamp=" + Math.random(),
        type: 'get',
        dataType: 'json',
        error: function(request) {
          alert("操作错误，请于管理员联系");
        },
        success: function(data) {
          $('#coupon_contract_id option').remove();
          for(var i=0;i<data.length; i++){
            $('<option value="' + data[i][1] + '">' + data[i][0] + '</option>').appendTo('#coupon_contract_id');
          }
        }
      });
    });

    // 取得具体合同信息
    $('#coupon_contract_id').change(function(){
      if($(this).val() == ''){
        $('#contact_code').html('');
        }else{
        $.ajax({
          url: '/remote/contract/' + $(this).val() + "?timestamp=" + Math.random(),
          type: 'get',
          dataType: 'json',
          error: function(request) {
            alert("操作错误，请于管理员联系");
          },
          success: function(data) {
            $('#contact_code').html("   合同编号：" + data.code);
          }
        });
      }
    });

    //经销商-店面联动选择
    $('#coupon_distributor_id').change(function(){
      $('#coupon_shop_id option').remove();
      $('#coupon_shop_id').append($('<option value="">数据查询中</option>'));
      $.ajax({
        url: '/admin/distributors/' + $(this).val() + '/shops_json',
        type: 'get',
        //data: {'distributor_id' : $(this).val()},
        dataType: 'json',

        error: function(request) {
          alert(request.responseText);
        },

        success: function(data) {
          $('#coupon_shop_id option').remove();
          if (data.length==0) $('#coupon_shop_id').append($('<option value="">没有店面</option>'));
          for(var i=0;i<data.length; i++){
            $('<option value="' + data[i][1] + '">' + data[i][0] + '</option>').appendTo('#coupon_shop_id');
          }
        }
      });
    });

    //行业-品牌联动选择
    $('#coupon_tag_id').change(function(){
      var tag_id = $(this).val();
      if (tag_id=='') tag_id = '0';
      $('#coupon_brand_id option').remove();
      $('#coupon_brand_id').append($('<option value="">数据查询中</option>'));
      $.ajax({
        url: '/pinlei/' + tag_id + '/pinpai',
        type: 'get',
        //data: {'distributor_id' : $(this).val()},
        dataType: 'json',

        error: function(request) {
          alert(request.responseText);
        },

        success: function(data) {
          $('#coupon_brand_id option').remove();
          if (data.length==0) $('#coupon_brand_id').append($('<option value="">没有品牌</option>'));
          for(var i=0;i<data.length; i++){
            $('<option value="' + data[i].id + '">' + data[i].name_zh + '</option>').appendTo('#coupon_brand_id');
          }
          get_production_categories();
        }
      });
    });

    ///categories/for_tag_and_brand
    //品牌/行业-品类联动
    $('#coupon_brand_id').change(function(){
      get_production_categories();
    });

    function get_production_categories(){
      $('#production_category_ids_td').text('').empty;
      $('#production_category_ids_td').text('品类查询中...');
      $.ajax({
        url: '/categories/for_tag_and_brand',
        type: 'get',
        data: {'tag_id' : $('#coupon_tag_id').val(), 'brand_id' : $('#coupon_brand_id').val() },
        dataType: 'json',

        error: function(request) {
          alert(request.responseText);
        },

        success: function(data) {
          $('#production_category_ids_td').text('').empty;
          if (data.length==0) $('#production_category_ids_td').text('没有搜索到任何品类');
          for(var i=0;i<data.length; i++){
            $('<input name="production_category_ids[]" type="checkbox" value="' + data[i][1] + '" /> <span>' + data[i][0] + '</span>').appendTo('#production_category_ids_td');
          }
        }
      });
    }
    
  });

  function set_image(image_obj, obj){
    var src = 'http://js.51hejia.com/img/nil.gif';
    if ($.trim(obj.val()) != ''){
      src = ($("#coupon_form").attr("data-assetsurl") + obj.val()).replace(".com//",".com/");
    }
    image_obj.attr('src', src);
  }

  function set_defualt(obj){
    obj.attr('src', "http://js.51hejia.com/img/nil.gif");  
  }


  
</script>

