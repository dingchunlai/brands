<%= show_flash_message %>
<% is_new_record = @production.new_record? %>
<% form_for @production, :url => (is_new_record && admin_productions_path || admin_production_path(@production)), :html => {:method => (is_new_record && :post || :put)}  do |f| %>
  <fieldset>
    <table>
      <tr>
        <th>选择所属品类</th>
        <%# data-ajax-url 是js代码中需要的访问地址，不宜在js代码中生成，故在这里现生成，用':id:'作为占位符 %>
        <td><%= f.select :brand_category_id, category_select_collection, {:include_blank => '-- 请选择 --'}, 'data-ajax-url' => pinpai_pin_lei_path(':id:') %></td>
      </tr>
      <tr>
        <th>选择所属品牌</th>
        <% if @brand_tag %>
          <td><%= f.select(:brand_id, @brand_tag.brands.map { |b| [b.name_zh, b.id] }, {:include_blank => '-- 请选择 --'}, 'data-ajax-url' => series_brand_path(':id:')) %></td>
        <% else %>
          <td><%= f.select :brand_id, [['-- 请先选择品类 --', '']], {}, 'data-ajax-url' => series_brand_path(':id:') %></td>
        <% end %>
      </tr>
      <tr>
        <th>选择所属种类</th>
        <td><%= f.select :category_id, production_category_select_collection, {:include_blank => '-- 请选择 --' }, 'data-ajax-url' => attrs_category_path(':id:') %></td>
      </tr>
      <tr>
        <th>选择所属系列</th>
        <% if @production.brand %>
          <% if @production.brand.production_series.blank? %>
            <td><%= f.select :series_id, [['-- 没有可选系列 --', '']] %></td>
          <% else %>
            <td><%= f.select(:series_id, @production.brand.production_series.map { |s| [s.name, s.id] }, :include_blank => '-- 请选择 --') %></td>
          <% end %>
        <% else %>
          <td><%= f.select :series_id, [['-- 请先选择品牌 --', '']] %></td>
        <% end %>
      </tr>
      <tr>
        <th>产品名称</th>
        <td><%= f.text_field :name %></td>
      </tr>
      <tr>
        <th>产品型号</th>
        <td><%= f.text_field :model %></td>
      </tr>
      <tr>
        <th>产品描述</th>
        <td><%= f.text_area :description, :class => 'mceEditor' %></td>
      </tr>
      <tr>
        <th>技术参数</th>
        <td>
          <table id="property_area">
            <tbody>
              <tr>
                <% if @production.category %>
                  <% if @production.category.attrs.blank? %>
                    <td colspan="2">-- 没有参数可用 --</td>
                  <% else %>
                    <% @production.category.attrs.each do |attribute| %>
                      <tr>
                        <th><%= attribute.name %></th>
                        <%
                          value =
                            if property = @production.properties.detect { |p| p.attribute_id == attribute.id }
                              property.value
                            else
                              ''
                            end
                        %>
                        <td><%= text_field_tag("properties[#{attribute.id}]", value, :id => "properties_#{attribute.id}")%></td>
                      </tr>
                    <% end %>
                  <% end %>
                <% else %>
                  <td colspan="2">-- 请先选择产品种类 --</td>
                <% end %>
              </tr>
            </tbody>
          </table>
        </td>
      </tr>
      <tr>
        <td colspan="2"><%= submit_tag '保存' %></td>
      </tr>
    </table>
  </fieldset>
<% end %>

<%= render :partial => 'shared/enable_tinymce' %>

<script type="text/javascript">
  (function() {
    // 处理品类发生变化之后的情况
    function handleCategoryChange() {
      $('#production_brand_category_id').change(function(event) {
        event.preventDefault();
        var id = $(this).val();
        if(!id || id == '') {
          updateBrandSelectElement([]);
          return false;
        }
        var url = $(this).attr('data-ajax-url').replace(':id:', id);
        $.getJSON(url, function(data, textStatus) {
          if(textStatus == 'success') {
            updateBrandSelectElement(data);
          } else {
            alert('读取品牌数据出错！');
          }
        });
        return false;
      });
    }

    // 更新品牌下拉框
    function updateBrandSelectElement(brands) {
      var dom = $('#production_brand_id').empty();
      if(!brands || brands.length < 1) {
        $('<option />').val('').text('-- 没有品牌可选 --').appendTo(dom);
      } else {
        $('<option />').val('').text('-- 请选择 --').appendTo(dom);
        $.each(brands, function(_, brand) {
          $('<option />').val(brand.id).text(brand.name_zh).appendTo(dom);
        })
      }
    }

    // 处理品牌发生变化之后的情况
    function handleBrandChange() {
      $('#production_brand_id').change(function(event) {
        event.preventDefault();
        var id = $(this).val();
        if(!id || id == '') {
          updateBrandSelectElement([]);
          return false;
        }
        var url = $(this).attr('data-ajax-url').replace(':id:', id);
        $.getJSON(url, function(data, textStatus) {
          if(textStatus == 'success') {
            updateSeriesSelectElement(data);
          } else {
            alert('读取产品系列数据出错！');
          }
        });
        return false;
      });
    }

    // 更新系列下拉框
    function updateSeriesSelectElement(series) {
      var dom = $('#production_series_id').empty();
      $.each(series, function(_, s) {
        $('<option />').val(s.id).text(s.name).appendTo(dom);
      })
      if(!series || series.length < 1) {
        $('<option />').val('').text('-- 没有系列可选 --').appendTo(dom);
      }
    }

    // 处理产品种类发生变化之后的情况
    function handleProductionCategoryChange() {
      $('#production_category_id').change(function(event) {
        event.preventDefault();
        var id = $(this).val();
        if(!id || id == '') {
          updatePropertyEditArea([]);
          return false;
        }
        var url = $(this).attr('data-ajax-url').replace(':id:', id);
        $.getJSON(url, function(data, textStatus) {
          if(textStatus == 'success') {
            updatePropertyEditArea(data);
          } else {
            alert('读取技术参数出错！');
          }
        });
        return false;
      });
    }

    // 更新技术参数编辑区
    function updatePropertyEditArea(attributes) {
      var dom = $('#property_area tbody').empty();
      $.each(attributes, function(_, attribute) {
        var tr = $('<tr />');
        $('<th />').text(attribute.name).appendTo(tr);
        $('<input type="text" name="properties[' + attribute.id + ']" id="properties_' + attribute.id + '" />').appendTo(
          $('<td />').appendTo(tr)
        );
        tr.appendTo(dom);
      })
      if(!attributes || attributes.length < 1) {
        $('<td />').attr('colspan', '2').text('-- 没有参数可用 --').appendTo(
          $('<tr />').appendTo(dom)
        );
      }
    }

    $(function() {
      handleCategoryChange();
      handleBrandChange();
      handleProductionCategoryChange();
    });
  })();
</script>
