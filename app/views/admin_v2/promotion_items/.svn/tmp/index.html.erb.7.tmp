<script type="text/javascript" src="http://js.51hejia.com/js/dialog.js"></script>
<script type="text/javascript">
  function open_lee_dialog(url){
    dialog('资源列表','url:get?' + url,'800px','600px','text');
  }
</script>
<style type="text/css">
  #floatBoxBg{width:100%;height:100%;background:#000;filter:alpha(opacity=50);opacity:0.5;position:absolute;top:0;left:0;}
  .floatBox{border:#666 5px solid;width:300px;position:absolute;top:50px;left:40%;}
  .floatBox .title{height:23px;padding:7px 10px 0;background:#333;color:#fff;}
  .floatBox .title h4{float:left;padding:0;margin:0;font-size:14px;line-height:16px;}
  .floatBox .title span{float:right;cursor:pointer;}
  .floatBox .content{padding:20px 15px;background:#fff;}
</style>

<%= show_flash_message %>
<div style="margin-bottom: 10px; line-height: 25px;">
  推广位名称：<%=@collection.name%>　
  代号：<%=@collection.code%>　
  类别：<%=Hejia::Promotable.all[@collection.item_type]%>　
  项数：<b><%=@items.length%></b> / <%=@collection.size%>　
  <%=link_to '新建推广项', admin_promotion_items_path(@collection.code)%>
  <%=  @collection.remark.blank? ? "" : "<br />推广位备注：<span style='color:#AA0000;'>#{@collection.remark}</span>"%>
</div>

<table border="1" >
  <tr style="height: 22px;">
    <th>标题</th>
    <th>类别</th>
    <th>优先级</th>
    <th style="width: 100px;">发布时间</th>
    <th style="width: 70px;">操作</th>
  </tr>
  <%="<tr><td colspan='5'>没有推广项记录...</td></tr>" if @items.length==0%>
  <%@items.each do |item|%>
    <tr>
      <td>
        <%=item.resource.promotion :title rescue "" %>
      </td>
      <td>
        <%=Hejia::Promotable.all[@collection.item_type]%>
      </td>
      <td>
        <%=item.priority%>
      </td>
      <td>
        <%=item.published_at.strftime("%Y-%m-%d %H:%M") rescue ""%>
      </td>
      <td>
        <%=link_to '编辑', admin_promotion_items_path(@collection.code, :item_id => item.id) %>
        <%=link_to '删除', admin_promotion_item_path(@collection.code, item.id), :method => :delete%>
      </td>
    </tr>
  <%end%>
</table>

<%is_new_record = @item.new_record?%>
<%form_for :item, @item, :url => (is_new_record && admin_promotion_items_path(params[:code]) || admin_promotion_item_path(params[:code], @item)), :html => {:id=>'item_form', 'data-uploadurl' => cloud_fs_upload_path('image'), 'data-assetsurl' => cloud_fs_domain('image'), :method => (is_new_record && :post || :put)}  do |f|%>
  <fieldset>
    <table>
      <tr>
        <td></td>
        <td style="height:40px;">
          <%if @item.new_record?%>
            添加推广项
          <%else%>
            编辑推广项
          <%end%>
          <input type="hidden" name="collection_item_type" value="<%=@collection.item_type%>" />
        </td>
      </tr>
      <tr>
        <td>优先级</td>
        <td style="text-align: left">
          <%=f.text_field :priority, :style=>"width:54px;"%>
          <%=select_tag :priority_shortcut, options_for_select([['快捷','']].concat((1..20).to_a.map{|i| [i,i]}))%>
        </td>
      </tr>
      <tr>
        <td>发布时间</td>
        <td style="text-align: left"><%=f.text_field :published_at, :value => f.object.published_at && f.object.published_at.strftime("%Y-%m-%d %H:%M:%S"), :style => "width:114px;"%></td>
      </tr>
      <tr <%="style='display:none;'" if @collection.item_type=="GeneralResource"%> >
        <td>资源编号</td>
        <td style="text-align: left">
          <%=f.text_field :resource_id, :style=>"width:70px;"%>
          <input type="button" value="选取" onclick="open_lee_dialog('/admin_v2/promotion_collections/resource_list?item_type=<%=@collection.item_type%>');" />
        </td>
      </tr>

      <%if @collection.item_type=="GeneralResource"%>
        <%fields_for :resource do |res| %>
          <tr>
            <td>标题</td>
            <td style="text-align: left">
              <%=res.text_field :title, :style=>"width:400px;"%>
            </td>

          </tr>

          <tr>
            <td>链接</td>
            <td style="text-align: left">
              <%=res.text_field :url, :style=>"width:400px;"%>
            </td>
          </tr>

          <tr>
            <td>图片</td>
            <td style="text-align: left">
              <img id="image_thumb" width="110" height="110" alt="主题图片预览" />
              <span id="main_image_upload_button"></span>
              <%=res.text_field :image_url, :style=>"display:none;"%>
            </td>
          </tr>

          <tr>
            <td>描述</td>
            <td style="text-align: left">
              <%=res.text_area :description, :rows=>5, :style=>"width:400px;"%>
            </td>
          </tr>

          <tr>
            <td>内容</td>
            <td style="text-align: left">
              <%=res.text_area :content, :class => 'mceEditor'%>
            </td>
          </tr>

        <%end%>
      <%end%>

      <tr>
        <td></td>
        <td><%= submit_tag '提交保存' %><% if session[:back] %>&nbsp;&nbsp;&nbsp;<%= link_to "返回上级目录", back_admin_redirection_addresses_path  %><% end %></td>
      </tr>
    </table>
  </fieldset>
<%end%>

<%= render :partial => 'shared/enable_tinymce' %>

<%content_for :html_head do%>
  <style type="text/css">
    table, td
    {
      border-color: #7EBF4F;
      border-style: solid;
    }

    table
    {
      border-width: 0 0 1px 1px;
      border-spacing: 0;
      border-collapse: collapse;
    }

    td
    {
      margin: 0;
      padding: 4px;
      border-width: 1px 1px 0 0;
      background-color: #FFC;
      text-align: center;
    }
  </style>

  <script src="http://js.51hejia.com/js/jquery.uploadify.v2.1.0.min.js" type="text/javascript"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/swfobject/2/swfobject.js" type="text/javascript"></script>
  <script src="http://js.51hejia.com/js/brands/uploadify/admin_general_resource.js?<%=Time.now.to_i%>" type="text/javascript"></script>
  <script type="text/javascript">
    $(function(){
      set_main_image();
      //$("#item_form").submit(form_on_submit);
      $("#priority_shortcut").change(function(){
        $("#item_priority").val(this.value);
      })
      $("#item_published_at").datepicker({dateFormat: 'yy-m-d'});
    })

    function set_main_image(){
      if ($.trim($("#resource_image_url").val())=="")
        $("#image_thumb").attr('src', "http://js.51hejia.com/img/nil.gif");
      else
        $("#image_thumb").attr('src', ($("#item_form").attr("data-assetsurl") + $("#resource_image_url").val()).replace(".com//",".com/"));
    }
  </script>
<%end%>
